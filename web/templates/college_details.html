{% extends "layout.html" %}

{% block title %}College Counselor - College Details{% endblock %}

{% block content %}
<div class="college-details-section">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="page-title">{{ college.name }}</h1>
          <a href="{{ url_for('colleges') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-1"></i> Back to Recommendations
          </a>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-8">
        <div class="card mb-4">
          <div class="card-header">
            <h3>College Overview</h3>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-md-6">
                <h5>Location</h5>
                <p>{{ college.location }}</p>
                
                <h5>Type</h5>
                <p>{{ college.type }}</p>
                
                <h5>Size</h5>
                <p>{{ college.size }} students</p>
              </div>
              <div class="col-md-6">
                <h5>Acceptance Rate</h5>
                <p>{{ college.acceptance_rate }}%</p>
                
                <h5>Average Cost</h5>
                <p>${{ college.average_cost }} per year</p>
                
                <h5>Setting</h5>
                <p>{{ college.setting }}</p>
              </div>
            </div>
            
            <h5>Description</h5>
            <p>{{ college.description }}</p>
            
            <h5>Popular Majors</h5>
            <ul>
              {% for major in college.popular_majors %}
                <li>{{ major }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h3>Academic Profile</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h5>Average GPA</h5>
                <p>{{ college.average_gpa }}</p>
                
                <h5>Average SAT</h5>
                <p>{{ college.average_sat }}</p>
              </div>
              <div class="col-md-6">
                <h5>Average ACT</h5>
                <p>{{ college.average_act }}</p>
                
                <h5>Student-Faculty Ratio</h5>
                <p>{{ college.student_faculty_ratio }}</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h3>Financial Information</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h5>Tuition</h5>
                <p>${{ college.tuition }} per year</p>
                
                <h5>Room & Board</h5>
                <p>${{ college.room_and_board }} per year</p>
              </div>
              <div class="col-md-6">
                <h5>Financial Aid</h5>
                <p>{{ college.financial_aid_percent }}% of students receive aid</p>
                
                <h5>Average Aid Package</h5>
                <p>${{ college.average_aid_package }} per year</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- New College-Specific Chat Interface -->
        <div class="card">
          <div class="card-header">
            <h3>Ask About {{ college.name }}</h3>
          </div>
          <div class="card-body">
            <p class="mb-3">Have questions about this college? Ask Promethios for personalized insights and explanations.</p>
            
            <form method="post" action="{{ url_for('chat_interface') }}" id="collegeQuestionForm">
              <input type="hidden" name="college_id" value="{{ college.id }}">
              
              <div class="input-group mb-3">
                <input type="text" class="form-control" name="query" id="collegeQuestion" placeholder="Ask a question about {{ college.name }}..." required>
                <button class="btn btn-primary" type="submit">
                  <i class="fas fa-paper-plane me-1"></i> Ask
                </button>
              </div>
            </form>
            
            <div class="suggested-questions mt-3">
              <p><strong>Suggested questions:</strong></p>
              <div class="d-flex flex-wrap">
                <button class="btn btn-sm btn-outline-secondary me-2 mb-2 suggested-question" data-question="Why is {{ college.name }} a good fit for me?">Why is this a good fit for me?</button>
                <button class="btn btn-sm btn-outline-secondary me-2 mb-2 suggested-question" data-question="What are my chances of getting into {{ college.name }}?">What are my chances?</button>
                <button class="btn btn-sm btn-outline-secondary me-2 mb-2 suggested-question" data-question="How does {{ college.name }} compare to other colleges in my list?">How does it compare?</button>
                <button class="btn btn-sm btn-outline-secondary me-2 mb-2 suggested-question" data-question="What are the strengths and weaknesses of {{ college.name }} for my profile?">Strengths & weaknesses?</button>
              </div>
            </div>
            
            {% if explanation %}
            <div class="chat-response mt-4">
              <div class="chat-bubble">
                <div class="chat-header">
                  <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Promethios" class="chat-avatar">
                  <span class="chat-name">Promethios College Counselor</span>
                </div>
                <div class="chat-content">
                  {{ explanation|safe|replace('\n', '<br>')|replace('  ', '&nbsp;&nbsp;') }}
                </div>
                <div class="chat-footer">
                  <small class="text-muted">Powered by Promethios Kernel</small>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header">
            <h3>Trust Score: {{ trust_score.overall_score }}</h3>
          </div>
          <div class="card-body">
            <div class="text-center mb-4">
              <div class="trust-score-circle {{ 'high-score' if trust_score.overall_score >= 80 else 'medium-score' if trust_score.overall_score >= 60 else 'low-score' }}">
                {{ trust_score.overall_score }}
              </div>
            </div>
            
            <h5>Trust Score Breakdown</h5>
            {% for factor in trust_score.factors %}
              <div class="mb-3">
                <div class="d-flex justify-content-between">
                  <span>{{ factor.name }}</span>
                  <span>{{ factor.score }}</span>
                </div>
                <div class="progress">
                  <div class="progress-bar {{ 'bg-success' if factor.score >= 80 else 'bg-primary' if factor.score >= 60 else 'bg-danger' }}" role="progressbar" style="width: {{ factor.score }}%;" aria-valuenow="{{ factor.score }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <small class="text-muted">{{ factor.description }}</small>
                
                <!-- New: Detailed explanation toggle -->
                <div class="mt-1">
                  <a href="#" class="factor-explanation-toggle" data-bs-toggle="collapse" data-bs-target="#factor-explanation-{{ loop.index }}">
                    <i class="fas fa-info-circle"></i> Why this score?
                  </a>
                  <div class="collapse mt-2" id="factor-explanation-{{ loop.index }}">
                    <div class="card card-body bg-light">
                      <p class="mb-0">{{ factor.detailed_explanation }}</p>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
            
            <!-- New: View Full Trust Analysis button -->
            <div class="d-grid gap-2 mt-4">
              <a href="{{ url_for('trust_visualization', college_id=college.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-chart-radar me-1"></i> View Full Trust Analysis
              </a>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h3>Match Analysis</h3>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="d-flex justify-content-between">
                <span>Academic Match</span>
                <span>{{ college.academic_match }}%</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-info" role="progressbar" style="width: {{ college.academic_match }}%;" aria-valuenow="{{ college.academic_match }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <!-- New: Match explanation -->
              <small class="text-muted">Based on your GPA, test scores, and academic interests.</small>
            </div>
            
            <div class="mb-3">
              <div class="d-flex justify-content-between">
                <span>Financial Match</span>
                <span>{{ college.financial_match }}%</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ college.financial_match }}%;" aria-valuenow="{{ college.financial_match }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <!-- New: Match explanation -->
              <small class="text-muted">Based on your budget and potential financial aid.</small>
            </div>
            
            <div class="mb-3">
              <div class="d-flex justify-content-between">
                <span>Social Match</span>
                <span>{{ college.social_match }}%</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-primary" role="progressbar" style="width: {{ college.social_match }}%;" aria-valuenow="{{ college.social_match }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <!-- New: Match explanation -->
              <small class="text-muted">Based on location preferences, campus culture, and size.</small>
            </div>
            
            <div class="mb-3">
              <div class="d-flex justify-content-between">
                <span>Overall Match</span>
                <span>{{ college.overall_match }}%</span>
              </div>
              <div class="progress">
                <div class="progress-bar {{ 'bg-success' if college.overall_match >= 80 else 'bg-primary' if college.overall_match >= 60 else 'bg-danger' }}" role="progressbar" style="width: {{ college.overall_match }}%;" aria-valuenow="{{ college.overall_match }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <!-- New: Match explanation -->
              <small class="text-muted">Weighted combination of all factors based on your priorities.</small>
            </div>
            
            <!-- New: View Detailed Comparison button -->
            <div class="d-grid gap-2 mt-4">
              <a href="{{ url_for('college_comparison') }}?college_ids={{ college.id }}" class="btn btn-outline-primary">
                <i class="fas fa-balance-scale me-1"></i> Compare With Other Colleges
              </a>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>Actions</h3>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button class="btn btn-primary" id="addToFavoritesBtn">
                <i class="fas fa-heart me-1"></i> Add to Favorites
              </button>
              <a href="{{ url_for('decision_explainer', college_id=college.id) }}" class="btn btn-success">
                <i class="fas fa-comment-dots me-1"></i> Get Decision Explanation
              </a>
              <a href="{{ college.website }}" target="_blank" class="btn btn-outline-secondary">
                <i class="fas fa-external-link-alt me-1"></i> Visit Website
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add to favorites functionality
    const addToFavoritesBtn = document.getElementById('addToFavoritesBtn');
    if (addToFavoritesBtn) {
      addToFavoritesBtn.addEventListener('click', function() {
        // In a real app, this would call an API to add to favorites
        window.notificationSystem.success('Added to favorites!');
        addToFavoritesBtn.innerHTML = '<i class="fas fa-heart me-1"></i> Added to Favorites';
        addToFavoritesBtn.disabled = true;
      });
    }
    
    // Suggested questions functionality
    const suggestedQuestions = document.querySelectorAll('.suggested-question');
    const collegeQuestionInput = document.getElementById('collegeQuestion');
    
    suggestedQuestions.forEach(button => {
      button.addEventListener('click', function() {
        const question = this.getAttribute('data-question');
        collegeQuestionInput.value = question;
        document.getElementById('collegeQuestionForm').submit();
      });
    });
    
    // Smooth scrolling to chat response if present
    const chatResponse = document.querySelector('.chat-response');
    if (chatResponse) {
      chatResponse.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
</script>

<style>
  .trust-score-circle {
    font-size: 2rem;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin: 0 auto;
  }
  
  .high-score {
    background-color: #28a745;
  }
  
  .medium-score {
    background-color: #007bff;
  }
  
  .low-score {
    background-color: #dc3545;
  }
  
  .factor-explanation-toggle {
    font-size: 0.85rem;
    text-decoration: none;
  }
  
  .chat-bubble {
    background-color: #f8f9fa;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  .chat-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .chat-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
  }
  
  .chat-name {
    font-weight: bold;
  }
  
  .chat-content {
    font-size: 1.1rem;
    line-height: 1.6;
    white-space: pre-line;
  }
  
  .chat-footer {
    margin-top: 10px;
    text-align: right;
  }
</style>
{% endblock %}
