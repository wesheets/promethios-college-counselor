{% extends "layout.html" %}

{% block title %}College Counselor - Colleges{% endblock %}

{% block content %}
<div class="colleges-section">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1 class="page-title">College Recommendations</h1>
        <p class="lead">Discover colleges that match your profile with transparent trust scores.</p>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-body">
            <h3>Search Colleges</h3>
            <form id="searchForm" class="row g-3">
              <div class="col-md-6">
                <input type="text" class="form-control" id="searchQuery" placeholder="Search by name, location, or major...">
              </div>
              <div class="col-md-4">
                <select class="form-select" id="filterType">
                  <option value="all">All Colleges</option>
                  <option value="recommended">Recommended</option>
                  <option value="reach">Reach Schools</option>
                  <option value="target">Target Schools</option>
                  <option value="safety">Safety Schools</option>
                </select>
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Search</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-12">
        <div class="alert alert-info" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Trust Scores Explained:</strong> Our recommendations are based on multiple factors including academic profile match, emotional readiness, college fit, and budget alignment. Higher scores indicate stronger matches.
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <h3>Your Recommendations</h3>
        <div id="collegeRecommendations">
          <!-- Recommendations will be loaded here -->
          <div class="recommendation-placeholder">
            <p class="text-center text-muted">Loading recommendations...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- College Card Template (hidden) -->
<template id="collegeCardTemplate">
  <div class="col-md-6 mb-4">
    <div class="card college-card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="college-name mb-0"></h4>
        <span class="college-category-badge"></span>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-8">
            <p class="college-location mb-1"></p>
            <p class="college-website mb-1"></p>
            <p class="college-admission mb-0"></p>
          </div>
          <div class="col-md-4 text-center">
            <div class="trust-score-circle">
              <span class="trust-score-value"></span>
            </div>
            <p class="trust-score-label">Trust Score</p>
          </div>
        </div>
        
        <h5>Trust Factors</h5>
        <div class="trust-factors mb-3">
          <!-- Trust factors will be added here -->
        </div>
        
        <div class="college-majors mb-3">
          <h5>Available Majors</h5>
          <div class="majors-list"></div>
        </div>
        
        <div class="college-cost">
          <h5>Cost Information</h5>
          <table class="table table-sm">
            <tr>
              <td>Tuition:</td>
              <td class="college-tuition text-end"></td>
            </tr>
            <tr>
              <td>Room & Board:</td>
              <td class="college-room-board text-end"></td>
            </tr>
            <tr>
              <td>Total Cost:</td>
              <td class="college-total-cost text-end fw-bold"></td>
            </tr>
            <tr>
              <td>Avg. Financial Aid:</td>
              <td class="college-financial-aid text-end"></td>
            </tr>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <div class="d-flex justify-content-between">
          <button class="btn btn-outline-primary btn-sm view-details-btn">View Details</button>
          <button class="btn btn-outline-secondary btn-sm override-btn" data-bs-toggle="modal" data-bs-target="#overrideModal">Override</button>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Trust Factor Template (hidden) -->
<template id="trustFactorTemplate">
  <div class="trust-factor mb-2">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <span class="factor-name"></span>
      <span class="factor-score"></span>
    </div>
    <div class="progress">
      <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  </div>
</template>

<!-- Override Modal -->
<div class="modal fade" id="overrideModal" tabindex="-1" aria-labelledby="overrideModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="overrideModalLabel">Override Recommendation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="overrideForm">
          <input type="hidden" id="overrideCollegeId" value="">
          
          <div class="mb-3">
            <label for="overrideAction" class="form-label">Action</label>
            <select class="form-select" id="overrideAction" required>
              <option value="" selected disabled>Select action</option>
              <option value="include">Include in recommendations</option>
              <option value="exclude">Exclude from recommendations</option>
              <option value="prioritize">Prioritize in recommendations</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="overrideJustification" class="form-label">Justification</label>
            <textarea class="form-control" id="overrideJustification" rows="4" placeholder="Please provide a detailed justification for this override..." required></textarea>
            <div class="form-text">Your justification will be recorded and included in the audit trail.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveOverrideBtn">Save Override</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Sample college recommendations for demo
    const sampleRecommendations = [
      {
        college: {
          id: "1",
          name: "Ivy University",
          location: {
            city: "Cambridge",
            state: "MA",
            zip: "02138"
          },
          website: "https://www.ivy.edu",
          admission_rate: 0.05,
          average_gpa: 4.0,
          cost: {
            tuition: 55000,
            room_and_board: 18000,
            books: 1200,
            total: 74200
          },
          financial_aid: {
            average_package: 45000,
            percent_receiving_aid: 60
          },
          majors: [
            "Computer Science",
            "Economics",
            "Biology",
            "Engineering",
            "Mathematics"
          ],
          enrollment: 20000,
          campus_setting: "urban"
        },
        trust_score: 65,
        category: "reach",
        factors: {
          academic_profile: {
            score: 60,
            weight: 1.0,
            explanation: {
              factor: "Academic Profile",
              score: 60,
              components: {
                gpa_match: 50,
                major_match: 80,
                location_match: 60
              },
              summary: "Your GPA is below the typical range for this college."
            }
          },
          emotional_state: {
            score: 85,
            weight: 1.2,
            explanation: {
              factor: "Emotional State",
              score: 85,
              components: {
                sentiment: 80,
                uncertainty: 90,
                agitation: 85
              },
              summary: "Your emotional state appears balanced for decision-making."
            }
          },
          college_match: {
            score: 70,
            weight: 1.0,
            explanation: {
              factor: "College Match",
              score: 70,
              components: {
                admission_likelihood: 40,
                school_fit: 90
              },
              summary: "This college may be a reach for your academic profile."
            }
          },
          budget_alignment: {
            score: 50,
            weight: 0.8,
            explanation: {
              factor: "Budget Alignment",
              score: 50,
              components: {
                cost_match: 40,
                affordability: 60
              },
              summary: "This college is moderately aligned with your budget."
            }
          }
        },
        halt_recommended: false
      },
      {
        college: {
          id: "2",
          name: "State University",
          location: {
            city: "Stateville",
            state: "CA",
            zip: "90210"
          },
          website: "https://www.stateuniversity.edu",
          admission_rate: 0.65,
          average_gpa: 3.5,
          cost: {
            tuition: 15000,
            room_and_board: 12000,
            books: 1000,
            total: 28000
          },
          financial_aid: {
            average_package: 12000,
            percent_receiving_aid: 75
          },
          majors: [
            "Business",
            "Psychology",
            "Communications",
            "Computer Science",
            "Biology"
          ],
          enrollment: 35000,
          campus_setting: "suburban"
        },
        trust_score: 85,
        category: "target",
        factors: {
          academic_profile: {
            score: 80,
            weight: 1.0,
            explanation: {
              factor: "Academic Profile",
              score: 80,
              components: {
                gpa_match: 80,
                major_match: 90,
                location_match: 70
              },
              summary: "Your academic profile is a good match for this college."
            }
          },
          emotional_state: {
            score: 85,
            weight: 1.2,
            explanation: {
              factor: "Emotional State",
              score: 85,
              components: {
                sentiment: 80,
                uncertainty: 90,
                agitation: 85
              },
              summary: "Your emotional state appears balanced for decision-making."
            }
          },
          college_match: {
            score: 85,
            weight: 1.0,
            explanation: {
              factor: "College Match",
              score: 85,
              components: {
                admission_likelihood: 80,
                school_fit: 90
              },
              summary: "This college is a strong match for both your academic profile and preferences."
            }
          },
          budget_alignment: {
            score: 90,
            weight: 0.8,
            explanation: {
              factor: "Budget Alignment",
              score: 90,
              components: {
                cost_match: 90,
                affordability: 90
              },
              summary: "This college aligns well with your budget and is affordable."
            }
          }
        },
        halt_recommended: false
      },
      {
        college: {
          id: "3",
          name: "Liberal Arts College",
          location: {
            city: "Smalltown",
            state: "VT",
            zip: "05401"
          },
          website: "https://www.liberalarts.edu",
          admission_rate: 0.25,
          average_gpa: 3.8,
          cost: {
            tuition: 45000,
            room_and_board: 14000,
            books: 1100,
            total: 60100
          },
          financial_aid: {
            average_package: 35000,
            percent_receiving_aid: 80
          },
          majors: [
            "English",
            "Philosophy",
            "History",
            "Art",
            "Political Science"
          ],
          enrollment: 2500,
          campus_setting: "rural"
        },
        trust_score: 70,
        category: "target",
        factors: {
          academic_profile: {
            score: 75,
            weight: 1.0,
            explanation: {
              factor: "Academic Profile",
              score: 75,
              components: {
                gpa_match: 70,
                major_match: 60,
                location_match: 90
              },
              summary: "Your academic profile is a good match for this college."
            }
          },
          emotional_state: {
            score: 85,
            weight: 1.2,
            explanation: {
              factor: "Emotional State",
              score: 85,
              components: {
                sentiment: 80,
                uncertainty: 90,
                agitation: 85
              },
              summary: "Your emotional state appears balanced for decision-making."
            }
          },
          college_match: {
            score: 65,
            weight: 1.0,
            explanation: {
              factor: "College Match",
              score: 65,
              components: {
                admission_likelihood: 60,
                school_fit: 70
              },
              summary: "This college is a moderate match for your profile and preferences."
            }
          },
          budget_alignment: {
            score: 60,
            weight: 0.8,
            explanation: {
              factor: "Budget Alignment",
              score: 60,
              components: {
                cost_match: 50,
                affordability: 70
              },
              summary: "This college is moderately aligned with your budget."
            }
          }
        },
        halt_recommended: false
      },
      {
        college: {
          id: "4",
          name: "Tech Institute",
          location: {
            city: "Techville",
            state: "WA",
            zip: "98101"
          },
          website: "https://www.techinstitute.edu",
          admission_rate: 0.15,
          average_gpa: 3.9,
          cost: {
            tuition: 50000,
            room_and_board: 16000,
            books: 1500,
            total: 67500
          },
          financial_aid: {
            average_package: 30000,
            percent_receiving_aid: 70
          },
          majors: [
            "Computer Science",
            "Electrical Engineering",
            "Mechanical Engineering",
            "Data Science",
            "Robotics"
          ],
          enrollment: 15000,
          campus_setting: "urban"
        },
        trust_score: 78,
        category: "reach",
        factors: {
          academic_profile: {
            score: 75,
            weight: 1.0,
            explanation: {
              factor: "Academic Profile",
              score: 75,
              components: {
                gpa_match: 70,
                major_match: 95,
                location_match: 60
              },
              summary: "Your academic profile is a good match for this college."
            }
          },
          emotional_state: {
            score: 85,
            weight: 1.2,
            explanation: {
              factor: "Emotional State",
              score: 85,
              components: {
                sentiment: 80,
                uncertainty: 90,
                agitation: 85
              },
              summary: "Your emotional state appears balanced for decision-making."
            }
          },
          college_match: {
            score: 80,
            weight: 1.0,
            explanation: {
              factor: "College Match",
              score: 80,
              components: {
                admission_likelihood: 70,
                school_fit: 90
              },
              summary: "This college is a strong match for both your academic profile and preferences."
            }
          },
          budget_alignment: {
            score: 70,
            weight: 0.8,
            explanation: {
              factor: "Budget Alignment",
              score: 70,
              components: {
                cost_match: 60,
                affordability: 80
              },
              summary: "This college aligns well with your budget and is affordable."
            }
          }
        },
        halt_recommended: false
      }
    ];

    // Load sample recommendations
    loadCollegeRecommendations(sampleRecommendations);

    // Handle search form submission
    const searchForm = document.getElementById('searchForm');
    searchForm.addEventListener('submit', function(event) {
      event.preventDefault();
      
      const query = document.getElementById('searchQuery').value;
      const filterType = document.getElementById('filterType').value;
      
      // In a real app, this would be an API call
      console.log('Searching colleges:', { query, filterType });
      
      // For demo purposes, just filter the existing recommendations
      let filteredRecommendations = sampleRecommendations;
      
      if (query) {
        filteredRecommendations = filteredRecommendations.filter(rec => 
          rec.college.name.toLowerCase().includes(query.toLowerCase()) ||
          rec.college.location.state.toLowerCase().includes(query.toLowerCase()) ||
          rec.college.majors.some(major => major.toLowerCase().includes(query.toLowerCase()))
        );
      }
      
      if (filterType !== 'all') {
        filteredRecommendations = filteredRecommendations.filter(rec => 
          rec.category === filterType
        );
      }
      
      loadCollegeRecommendations(filteredRecommendations);
    });

    // Handle override form submission
    const saveOverrideBtn = document.getElementById('saveOverrideBtn');
    saveOverrideBtn.addEventListener('click', function() {
      const collegeId = document.getElementById('overrideCollegeId').value;
      const action = document.getElementById('overrideAction').value;
      const justification = document.getElementById('overrideJustification').value;
      
      if (!action || !justification) {
        alert('Please fill out all fields.');
        return;
      }
      
      // In a real app, this would be an API call
      console.log('Saving override:', { collegeId, action, justification });
      
      // Close the modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('overrideModal'));
      modal.hide();
      
      // Show success message
      alert('Override saved successfully!');
      
      // Reset the form
      document.getElementById('overrideForm').reset();
    });
  });

  function loadCollegeRecommendations(recommendations) {
    const recommendationsContainer = document.getElementById('collegeRecommendations');
    const template = document.getElementById('collegeCardTemplate');
    const factorTemplate = document.getElementById('trustFactorTemplate');
    
    // Clear container
    recommendationsContainer.innerHTML = '';
    
    if (recommendations.length === 0) {
      recommendationsContainer.innerHTML = '<p class="text-center text-muted">No colleges match your search criteria.</p>';
      return;
    }
    
    // Create a row for the cards
    const row = document.createElement('div');
    row.className = 'row';
    recommendationsContainer.appendChild(row);
    
    // Add recommendations
    recommendations.forEach(recommendation => {
      const clone = template.content.cloneNode(true);
      const college = recommendation.college;
      
      // Set college information
      clone.querySelector('.college-name').textContent = college.name;
      clone.querySelector('.college-location').textContent = `${college.location.city}, ${college.location.state} ${college.location.zip}`;
      clone.querySelector('.college-website').textContent = college.website;
      clone.querySelector('.college-admission').textContent = `Admission Rate: ${(college.admission_rate * 100).toFixed(1)}%`;
      
      // Set trust score
      const trustScore = Math.round(recommendation.trust_score);
      clone.querySelector('.trust-score-value').textContent = trustScore;
      
      // Set trust score color
      const trustScoreCircle = clone.querySelector('.trust-score-circle');
      if (trustScore >= 80) {
        trustScoreCircle.classList.add('high-score');
      } else if (trustScore >= 60) {
        trustScoreCircle.classList.add('medium-score');
      } else {
        trustScoreCircle.classList.add('low-score');
      }
      
      // Set category badge
      const categoryBadge = clone.querySelector('.college-category-badge');
      categoryBadge.textContent = recommendation.category.charAt(0).toUpperCase() + recommendation.category.slice(1);
      
      if (recommendation.category === 'reach') {
        categoryBadge.classList.add('badge', 'bg-danger');
      } else if (recommendation.category === 'target') {
        categoryBadge.classList.add('badge', 'bg-primary');
      } else if (recommendation.category === 'safety') {
        categoryBadge.classList.add('badge', 'bg-success');
      }
      
      // Add trust factors
      const trustFactorsContainer = clone.querySelector('.trust-factors');
      for (const [factorId, factor] of Object.entries(recommendation.factors)) {
        const factorClone = factorTemplate.content.cloneNode(true);
        
        // Format factor name
        const factorName = factor.explanation.factor;
        factorClone.querySelector('.factor-name').textContent = factorName;
        
        // Set factor score
        const factorScore = Math.round(factor.score);
        factorClone.querySelector('.factor-score').textContent = factorScore;
        
        // Set progress bar
        const progressBar = factorClone.querySelector('.progress-bar');
        progressBar.style.width = `${factorScore}%`;
        progressBar.setAttribute('aria-valuenow', factorScore);
        
        // Set progress bar color
        if (factorScore >= 80) {
          progressBar.classList.add('bg-success');
        } else if (factorScore >= 60) {
          progressBar.classList.add('bg-primary');
        } else if (factorScore >= 40) {
          progressBar.classList.add('bg-warning');
        } else {
          progressBar.classList.add('bg-danger');
        }
        
        trustFactorsContainer.appendChild(factorClone);
      }
      
      // Add majors
      const majorsList = clone.querySelector('.majors-list');
      const majorBadges = document.createElement('div');
      college.majors.forEach(major => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-light text-dark me-1 mb-1';
        badge.textContent = major;
        majorBadges.appendChild(badge);
      });
      majorsList.appendChild(majorBadges);
      
      // Set cost information
      clone.querySelector('.college-tuition').textContent = `$${college.cost.tuition.toLocaleString()}`;
      clone.querySelector('.college-room-board').textContent = `$${college.cost.room_and_board.toLocaleString()}`;
      clone.querySelector('.college-total-cost').textContent = `$${college.cost.total.toLocaleString()}`;
      clone.querySelector('.college-financial-aid').textContent = `$${college.financial_aid.average_package.toLocaleString()}`;
      
      // Set up override button
      const overrideBtn = clone.querySelector('.override-btn');
      overrideBtn.addEventListener('click', function() {
        document.getElementById('overrideCollegeId').value = college.id;
        document.getElementById('overrideModalLabel').textContent = `Override: ${college.name}`;
      });
      
      // Set up view details button
      const viewDetailsBtn = clone.querySelector('.view-details-btn');
      viewDetailsBtn.addEventListener('click', function() {
        alert(`Detailed view for ${college.name} would open here.`);
      });
      
      row.appendChild(clone);
    });
  }
</script>

<style>
  .trust-score-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    font-size: 24px;
    font-weight: bold;
    color: white;
  }
  
  .high-score {
    background-color: #28a745;
  }
  
  .medium-score {
    background-color: #007bff;
  }
  
  .low-score {
    background-color: #dc3545;
  }
  
  .trust-score-label {
    text-align: center;
    margin-top: 5px;
    font-size: 14px;
  }
  
  .college-card {
    transition: transform 0.2s;
  }
  
  .college-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
</style>
{% endblock %}
